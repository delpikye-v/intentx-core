"use strict";let e=0;function t(t){return Symbol(null!=t?t:"scope-"+ ++e)}const n={high:[],normal:[],low:[]};let o=!1;function l(e){var t,r,i;for(o=!0;n.high.length||n.normal.length||n.low.length;)if(n.high.length)null===(t=n.high.shift())||void 0===t||t();else if(n.normal.length)null===(r=n.normal.shift())||void 0===r||r();else if(n.low.length){if(e&&e.timeRemaining()<1)break;null===(i=n.low.shift())||void 0===i||i()}o=!1,n.low.length&&("undefined"!=typeof requestIdleCallback?requestIdleCallback(l):setTimeout(l,16))}function r(e,t="normal"){n[t].push(e),o||("high"===t?l():"undefined"!=typeof requestIdleCallback?requestIdleCallback(l):setTimeout(l,16))}const i={activeNode:null,activeEffect:null};let c=0;function a(e,t){return{id:++c,type:e,label:t,deps:new Set}}function u(e,t){e.deps.add(t)}let s=!1;const f=new Set;let d="low";const v=t("default");exports.batch=function(e){s=!0;try{e()}finally{s=!1,f.forEach(e=>r(e,d)),f.clear(),d="low"}},exports.compose=function(e){return(t,n)=>{let o=-1;const l=r=>{var i;if(r<=o)return Promise.reject();o=r;const c=null!==(i=e[r])&&void 0!==i?i:n;return Promise.resolve(c(t,()=>l(r+1)))};return l(0)}},exports.createComputed=function(e){let t,n=!0;const o=new Set,l=a("computed"),c=()=>{n||(n=!0,o.forEach(e=>r(e)))};return()=>{if(i.activeNode&&u(i.activeNode,l),i.activeEffect&&o.add(i.activeEffect),n){const o=i.activeNode,r=i.activeEffect;i.activeNode=l,i.activeEffect=c,t=e(),n=!1,i.activeNode=o,i.activeEffect=r}return t}},exports.createIntentBus=function(e){const t=new Map,n=new Map;function o(e){return null!=e?e:v}function l(e,t,o){var l;const r=null===(l=n.get(e))||void 0===l?void 0:l.get(t);return(null==r?void 0:r.length)?r.reduceRight((e,t)=>t(e),o):o}return{on(e,n,l){var r,i;const c=o(l),a=null!==(r=t.get(e))&&void 0!==r?r:new Map,u=null!==(i=a.get(c))&&void 0!==i?i:[];return u.push(n),a.set(c,u),t.set(e,a),()=>{var e;a.set(c,(null!==(e=a.get(c))&&void 0!==e?e:[]).filter(e=>e!==n))}},effect(e,t,l){var r,i;const c=o(l),a=null!==(r=n.get(e))&&void 0!==r?r:new Map,u=null!==(i=a.get(c))&&void 0!==i?i:[];u.push(t),a.set(c,u),n.set(e,a)},async emit(n,r,i){var c;const a=o(i),u=null===(c=t.get(n))||void 0===c?void 0:c.get(a);if(!(null==u?void 0:u.length))return;const s=e(r,a);for(const e of u){if(s.signal.aborted)break;const t=l(n,a,e);await t(s)}},scope:v}},exports.createScope=t,exports.intentEffect=function(e){const t=[],n=()=>n=>function(e,t){return e.reduceRight((e,t)=>t(e),t)}(t,async t=>(await(async t=>{t.signal.aborted||await e(t)})(t),n(t))),o=e=>n()(e);return o.takeLatest=()=>{let e=null;return t.push(t=>async n=>{if(null==e||e.abort(),e=new AbortController,!e.signal.aborted)return t({...n,signal:e.signal})}),o},o.debounce=e=>{let n;return t.push(t=>o=>new Promise(l=>{clearTimeout(n),n=setTimeout(()=>{o.signal.aborted||l(t(o))},e)})),o},o.retry=(e=3)=>(t.push(t=>async n=>{let o;for(let l=0;l<=e;l++)try{return await t(n)}catch(e){if(n.signal.aborted)return;o=e}throw o}),o),o},exports.linkNodes=u,exports.queueJob=function(e,t){s?(f.add(e),"high"===t?d="high":"normal"===t&&"low"===d&&(d="normal")):r(e,t)},exports.reactiveContext=i,exports.reactiveEffect=function(e,t="normal"){const n=a("effect","reactive");let o=!1;const l=()=>{if(!o)try{i.activeNode=n,i.activeEffect=l,e()}finally{i.activeNode=null,i.activeEffect=null}};return r(l,t),()=>{o=!0,n.deps.clear()}},exports.schedule=r,exports.trackNode=a;
