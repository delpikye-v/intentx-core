"use strict";function t(t){const e=new Map,n=new Map,o=new Map;return{on:function(t,n){var o;const r=null!==(o=e.get(t))&&void 0!==o?o:[];r.push(n),e.set(t,r)},effect:function(t,e){var o;const r=null!==(o=n.get(t))&&void 0!==o?o:[];r.push(e),n.set(t,r)},emit:async function(r,s,c){var a,u,l;const i=(e=>`${t}:${e}`)(r);null===(a=o.get(i))||void 0===a||a.abort();const f=new AbortController;o.set(i,f);const p=null!==(u=e.get(r))&&void 0!==u?u:[],d=null!==(l=n.get(r))&&void 0!==l?l:[];for(const e of p){let n=e;for(let t=d.length-1;t>=0;t--)n=d[t](n);await n({state:c.getState(),payload:s,signal:f.signal,scope:t,emit:c.emit,setState:c.setState})}}}}exports.compose=function(t){return function(e,n){let o=-1;return function r(s){var c;if(s<=o)return Promise.reject(new Error("next() called multiple times"));o=s;const a=null!==(c=t[s])&&void 0!==c?c:n;return Promise.resolve(a(e,()=>r(s+1)))}(0)}},exports.composeEffects=function(t){return e=>t.reduceRight((t,e)=>e(t),e)},exports.createBackendRuntime=function(e,n="backend"){const o=structuredClone(e);let r=structuredClone(e);const s=t(n),c={getState:()=>r,setState(t){t(r)},emit:l};let a=!1,u=[];async function l(t,e){a?u.push({intent:t,payload:e}):await s.emit(t,e,c)}async function i(){const t=u;u=[];for(const e of t)await l(e.intent,e.payload)}return{state:()=>r,snapshot:()=>structuredClone(r),setState(t){t(r)},replaceState(t){r=structuredClone(t)},reset(){r=structuredClone(o)},emit:l,batch(t){a=!0;try{const e=t();if(e instanceof Promise)return e.finally(()=>(a=!1,i()))}finally{return a=!1,i()}},onIntent:s.on,effect:s.effect}},exports.createIntentBus=t,exports.debounce=function(t){let e;return n=>o=>{clearTimeout(e),e=setTimeout(()=>{n(o)},t)}},exports.retry=function(t=3){return e=>async n=>{let o;for(let r=0;r<t;r++)try{return await e(n)}catch(t){o=t}throw o}},exports.takeLatest=function(){let t=null;return e=>async n=>(null==t||t.abort(),t=new AbortController,e({...n,signal:t.signal}))};
