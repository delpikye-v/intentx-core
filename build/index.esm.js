let e=0;function t(t){return Symbol(null!=t?t:"scope-"+ ++e)}const n={high:[],normal:[],low:[]};let o=!1;function l(){var e;o=!0;for(const t of["high","normal","low"])for(;n[t].length;)null===(e=n[t].shift())||void 0===e||e();o=!1}function c(e,t="normal"){n[t].push(e),o||queueMicrotask(l)}const r={activeNode:null,activeEffect:null};let i=0;function a(e,t){return{id:++i,type:e,label:t,deps:new Set}}function u(e,t="normal"){const n=a("effect","reactive");let o=!1;const l=()=>{if(!o)try{r.activeNode=n,r.activeEffect=l,e()}finally{r.activeNode=null,r.activeEffect=null}};return c(l,t),()=>{o=!0,n.deps.clear()}}let s=!1;const f=new Set;let d="low";function v(e){s=!0;try{e()}finally{s=!1,f.forEach(e=>c(e,d)),f.clear(),d="low"}}function p(e){let t,n=!0;const o=new Set,l=a("computed"),i=()=>{n||(n=!0,o.forEach(e=>{return t=e,n="normal",void(s?(f.add(t),"low"===d&&(d="normal")):c(t,n));var t,n}))};return()=>{if(r.activeNode&&r.activeNode.deps.add(l),r.activeEffect&&o.add(r.activeEffect),n){const o=r.activeNode,c=r.activeEffect;r.activeNode=l,r.activeEffect=i,t=e(),n=!1,r.activeNode=o,r.activeEffect=c}return t}}const w=t("default");function g(e){const t=new Map,n=new Map,o=e=>null!=e?e:w;return{on(e,n,l){const c=o(l),r=function(e,n){var o,l;const c=null!==(o=t.get(e))&&void 0!==o?o:new Map,r=null!==(l=c.get(n))&&void 0!==l?l:new Set;return c.set(n,r),t.set(e,c),r}(e,c);return r.add(n),()=>{var o;r.delete(n),r.size||null===(o=t.get(e))||void 0===o||o.delete(c)}},effect(e,t,l){const c=function(e,t){var o,l;const c=null!==(o=n.get(e))&&void 0!==o?o:new Map,r=null!==(l=c.get(t))&&void 0!==l?l:[];return c.set(t,r),n.set(e,c),r}(e,o(l));return c.push(t),()=>{const e=c.indexOf(t);0>e||c.splice(e,1)}},async emit(l,c,r){var i,a,u;const s=o(r),f=null===(i=t.get(l))||void 0===i?void 0:i.get(s);if(!(null==f?void 0:f.size))return;const d=e(c,s),v=null!==(u=null===(a=n.get(l))||void 0===a?void 0:a.get(s))&&void 0!==u?u:[];for(const e of f){const t=v.reduceRight((e,t)=>t(e),e);await t(d)}},scope:w}}function h(){const e=[],t=()=>t=>e.reduceRight((e,t)=>t(e),t);return t.takeLatest=()=>{let n=null;return e.push(e=>async t=>(null==n||n.abort(),n=new AbortController,e({...t,signal:n.signal}))),t},t.takeLeading=()=>{let n=!1;return e.push(e=>async t=>{if(!n){n=!0;try{return await e(t)}finally{n=!1}}}),t},t.debounce=n=>{let o;return e.push(e=>t=>new Promise(l=>{clearTimeout(o),o=setTimeout(()=>l(e(t)),n)})),t},t.throttle=n=>{let o=0;return e.push(e=>async t=>{const l=Date.now();if(l-o>=n)return o=l,e(t)}),t},t}export{v as batch,p as createComputed,g as createIntentBus,t as createScope,h as intentEffect,u as reactiveEffect,c as schedule};
