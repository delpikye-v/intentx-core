let e=0;function t(t){return Symbol(null!=t?t:"scope-"+ ++e)}const n={activeNode:null,nodes:new Set};let o=0;function c(e){const t={id:++o,type:e,deps:new Set};return n.nodes.add(t),t}function l(e,t){e.deps.add(t)}const i="undefined"==typeof globalThis||void 0===globalThis.__DEV__||globalThis.__DEV__;const r={high:new Set,normal:new Set,low:new Set};let a=!1;function u(){a=!0;for(const e of["high","normal","low"])for(const t of r[e])r[e].delete(t),t();a=!1}function s(e,t="normal"){r[t].add(e),a||queueMicrotask(u)}function f(){const e={activeEffect:null,activeDeps:null},t=function(e,t){return function(o){let r=o;const a=new Set,u=i?c("signal"):null,s=()=>{var t;const o=e.activeEffect;if(o&&(a.add(o),null===(t=e.activeDeps)||void 0===t||t.add(a)),i&&u){const e=n.activeNode;e&&l(e,u)}return r};return s.set=(n,o="normal")=>{Object.is(n,r)||(r=n,a.forEach(n=>{n!==e.activeEffect&&t(n,o)}))},s.subscribe=e=>(a.add(e),()=>a.delete(e)),s}}(e,s),o=function(e,t){return function(o){let r,a=!0;const u=new Set,s=new Set,f=i?c("computed"):null,d=()=>{a||(a=!0,u.forEach(e=>t(e,"normal")))};return()=>{var t;const c=e.activeEffect;if(c&&(u.add(c),null===(t=e.activeDeps)||void 0===t||t.add(u)),a){for(const e of s)e.delete(d);s.clear();const t=e.activeEffect,c=e.activeDeps,l=i?n.activeNode:null;e.activeEffect=d,e.activeDeps=s,i&&f&&(n.activeNode=f);try{r=o(),a=!1}finally{e.activeEffect=t,e.activeDeps=c,i&&(n.activeNode=l)}}if(i&&f){const e=n.activeNode;e&&l(e,f)}return r}}}(e,s),r=function(e,t){return function(o,l="normal"){let r=!1;const a=new Set,u=i?c("effect"):null,s=()=>{if(r)return;for(const e of a)e.delete(s);a.clear();const t=i?n.activeNode:null;try{e.activeEffect=s,e.activeDeps=a,i&&u&&(n.activeNode=u),o()}finally{e.activeEffect=null,e.activeDeps=null,i&&(n.activeNode=t)}};return t(s,l),()=>{r=!0;for(const e of a)e.delete(s);a.clear()}}}(e,s);return{signal:t,createComputed:o,reactiveEffect:r,context:e}}const d=f(),v=d.signal,p=d.createComputed,w=d.reactiveEffect,g=d.createComputed,h=d.reactiveEffect,y=new Set;let E="low";function m(e){try{e()}finally{for(const e of y)s(e,E);y.clear(),E="low"}}const S=t("default");function D(e){const t=new Map,n=new Map,o=e=>null!=e?e:S;return{on(e,n,c){const l=o(c),i=function(e,n){var o,c;const l=null!==(o=t.get(e))&&void 0!==o?o:new Map,i=null!==(c=l.get(n))&&void 0!==c?c:new Set;return l.set(n,i),t.set(e,l),i}(e,l);return i.add(n),()=>{var o;i.delete(n),i.size||null===(o=t.get(e))||void 0===o||o.delete(l)}},effect(e,t,c){const l=function(e,t){var o,c;const l=null!==(o=n.get(e))&&void 0!==o?o:new Map,i=null!==(c=l.get(t))&&void 0!==c?c:[];return l.set(t,i),n.set(e,l),i}(e,o(c));return l.push(t),()=>{const e=l.indexOf(t);0>e||l.splice(e,1)}},async emit(c,l,i){var r,a,u;const s=o(i),f=null===(r=t.get(c))||void 0===r?void 0:r.get(s);if(!(null==f?void 0:f.size))return;const d=e(l,s),v=(null!==(u=null===(a=n.get(c))||void 0===a?void 0:a.get(s))&&void 0!==u?u:[]).reduceRight((e,t)=>t(e),async e=>{for(const t of f)await t(e)});await v(d)},scope:S}}function b(){const e=[],t=()=>t=>e.reduceRight((e,t)=>t(e),t);return t.takeLatest=()=>{let n=null;return e.push(e=>async t=>(null==n||n.abort(),n=new AbortController,e({...t,signal:n.signal}))),t},t.takeLeading=()=>{let n=!1;return e.push(e=>async t=>{if(!n){n=!0;try{return await e(t)}finally{n=!1}}}),t},t.debounce=n=>{let o;return e.push(e=>t=>new Promise(c=>{clearTimeout(o),o=setTimeout(()=>c(e(t)),n)})),t},t.throttle=n=>{let o=0;return e.push(e=>async t=>{const c=Date.now();if(c-o>=n)return o=c,e(t)}),t},t}export{m as batch,g as computed,p as createComputed,D as createIntentBus,f as createReactiveRuntime,t as createScope,h as effect,b as intentEffect,w as reactiveEffect,s as schedule,v as signal};
